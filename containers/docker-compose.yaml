version: "3"
services:
  gds:
    build:
      context: ../
      dockerfile: ./containers/gds/Dockerfile
    image: trisa/gds
    init: true
    depends_on:
      - trtl
    ports:
      - 4433:4433
      - 4434:4434
      - 4435:4435
    volumes:
      - ../fixtures:/data
    environment:
      - GDS_DIRECTORY_ID=local.directory.dev
      - GDS_SECRET_KEY=supersecretsquirrel
      - GDS_MAINTENANCE=false
      - GDS_LOG_LEVEL=debug
      - GDS_CONSOLE_LOG=true
      - GDS_API_ENABLED=true
      - GDS_BIND_ADDR=:4433
      - GDS_ADMIN_ENABLED=true
      - GDS_ADMIN_BIND_ADDR=:4434
      - GDS_ADMIN_MODE=release
      - GDS_ADMIN_ALLOW_ORIGINS=http://localhost:3001,http://localhost:3000
      - GDS_ADMIN_COOKIE_DOMAIN=localhost
      - GDS_ADMIN_AUDIENCE=http://localhost:4433
      - GDS_ADMIN_TOKEN_KEYS=1y9jUjVqRqRJaiKsNqrZmQkhTqe:/data/creds/current_token_key.pem,1y9jTDgrljWl0iVUOQBcCev7rBG:/data/creds/rotated_token_key.pem
      - GDS_ADMIN_OAUTH_GOOGLE_AUDIENCE
      - GDS_ADMIN_OAUTH_AUTHORIZED_EMAIL_DOMAINS=trisa.io,rotational.io,akiltechnologies.com,100kode.io
      - GDS_MEMBERS_ENABLED=true
      - GDS_MEMBERS_BIND_ADDR=:4435
      - GDS_MEMBERS_INSECURE=true
      - GDS_MEMBERS_CERTS
      - GDS_MEMBERS_POOL
      - GDS_DATABASE_URL=trtl://trtl:4436/
      - GDS_DATABASE_REINDEX_ON_BOOT=false
      - GDS_DATABASE_INSECURE=true
      - GDS_DATABASE_CERT_PATH
      - GDS_DATABASE_POOL_PATH
      - SECTIGO_TESTING
      - SECTIGO_USERNAME
      - SECTIGO_PASSWORD
      - SECTIGO_PROFILE
      - GDS_SERVICE_EMAIL
      - GDS_ADMIN_EMAIL
      - SENDGRID_API_KEY
      - GDS_VERIFY_CONTACT_URL=http://localhost:3000/verify-contact
      - GDS_ADMIN_REVIEW_URL=http://localhost:3001/vasps/
      - GDS_EMAIL_TESTING=true
      - GDS_EMAIL_STORAGE=/data/emails
      - GDS_CERTMAN_INTERVAL=5m
      - GDS_CERTMAN_STORAGE=/data/certs
      - GDS_BACKUP_ENABLED=false
      - GDS_BACKUP_INTERVAL=1h
      - GDS_BACKUP_STORAGE=/data/backups
      - GDS_BACKUP_KEEP=1
      - GOOGLE_APPLICATION_CREDENTIALS
      - GOOGLE_PROJECT_NAME
      - GDS_SECRETS_TESTING
    profiles:
      - gds
      - api
      - all

  trtl:
    build:
      context: ../
      dockerfile: ./containers/trtl/Dockerfile
    image: trisa/trtl
    init: true
    ports:
      - 4436:4436
      - 7777:7777
    volumes:
      - ../fixtures:/data
    environment:
      - TRTL_MAINTENANCE=false
      - TRTL_BIND_ADDR=:4436
      - TRTL_METRICS_ADDR=:7777
      - TRTL_METRICS_ENABLED=true
      - TRTL_LOG_LEVEL=debug
      - TRTL_CONSOLE_LOG=true
      - TRTL_DATABASE_URL=leveldb:////data/trtl/db
      - TRTL_DATABASE_REINDEX_ON_BOOT=false
      - TRTL_REPLICA_ENABLED=false
      - TRTL_REPLICA_PID=8
      - TRTL_REPLICA_REGION=docker
      - TRTL_REPLICA_NAME=docker-8
      - TRTL_REPLICA_GOSSIP_INTERVAL=10s
      - TRTL_REPLICA_GOSSIP_SIGMA=1500ms
      - TRTL_INSECURE=true
      - TRTL_MTLS_CERT_PATH
      - TRTL_MTLS_CHAIN_PATH
      - TRTL_BACKUP_ENABLED=false
      - TRTL_BACKUP_INTERVAL=1h
      - TRTL_BACKUP_STORAGE=/data/backups
      - TRTL_BACKUP_KEEP=1
    profiles:
      - db
      - gds
      - api
      - all

  envoy:
    build:
      context: ../
      dockerfile: ./containers/grpc-proxy/Dockerfile
    image: trisa/grpc-proxy
    init: true
    depends_on:
      - gds
    ports:
      - 8080:8080
    profiles:
      - proxy
      - api
      - all

  gds-bff:
    build:
      context: ../
      dockerfile: ./containers/bff/Dockerfile
    image: trisa/gds-bff
    init: true
    depends_on:
      - gds
    ports:
      - 4437:4437
    environment:
      - GDS_BFF_MAINTENANCE=false
      - GDS_BFF_BIND_ADDR=:4437
      - GDS_BFF_MODE=release
      - GDS_BFF_LOG_LEVEL=debug
      - GDS_BFF_CONSOLE_LOG=true
      - GDS_BFF_TESTNET_INSECURE=true
      - GDS_BFF_TESTNET_ENDPOINT=gds:4433
      - GDS_BFF_TESTNET_TIMEOUT=5s
      - GDS_BFF_MAINNET_INSECURE=true
      - GDS_BFF_MAINNET_ENDPOINT=gds-mainnet:4433
      - GDS_BFF_MAINNET_TIMEOUT=5s
    profiles:
      - bff
      - api
      - all

  gds-ui:
    build:
      context: ../
      dockerfile: ./containers/gds-ui/Dockerfile
      args:
        REACT_APP_GDS_API_ENDPOINT: http://localhost:8080
        REACT_APP_GDS_IS_TESTNET: "true"
        REACT_APP_ANALYTICS_ID: ${REACT_APP_ANALYTICS_ID}
    image: trisa/gds-ui
    init: true
    depends_on:
      - envoy
    ports:
      - 3000:80
    profiles:
      - user
      - ui
      - all

  gds-admin-ui:
    build:
      context: ../
      dockerfile: ./containers/gds-admin-ui/Dockerfile
      args:
        REACT_APP_GDS_API_ENDPOINT: http://localhost:4434/v2
        REACT_APP_GDS_IS_TESTNET: "true"
        REACT_APP_GOOGLE_CLIENT_ID: ${REACT_APP_GOOGLE_CLIENT_ID}
    image: trisa/gds-admin-ui
    depends_on:
      - gds
    init: true
    ports:
      - 3001:80
    profiles:
      - admin
      - ui
      - all

  prometheus:
    image: prom/prometheus:latest
    depends_on:
      - trtl
    ports:
      - 9090:9090
    volumes:
      - ./monitor/prometheus.yml:/etc/prometheus/prometheus.yml
    profiles:
      - monitor
      - all

  grafana:
    image: grafana/grafana:latest
    depends_on:
      - prometheus
    ports:
      - 3002:3000
    volumes:
      - ./monitor/grafana:/var/lib/grafana
    profiles:
      - monitor
      - all